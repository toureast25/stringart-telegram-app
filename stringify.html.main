<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Telegram Mini App ‚Äî –§–æ—Ç–æ –∏ –ü–∞–ª–∏—Ç—Ä–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #0f1115;
      --card: #151924;
      --text: #e7e9ee;
      --muted: #9aa3b2;
      --accent: #2ea6ff;
      --border: #1f2430;
    }
    body { margin:0; font-family:system-ui,sans-serif; color:var(--text); background:var(--bg);}
    .app {display:flex;flex-direction:column;min-height:100dvh;}
    header.app-header{display:flex;gap:12px;padding:12px;background:var(--card);border-bottom:1px solid var(--border);}
    header.app-header button{border:1px solid var(--border);background:transparent;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;}
    header.app-header button.primary{background:var(--accent);border-color:transparent;color:#081018;}
    main{display:grid;place-items:center;padding:16px;flex:1;}
    .card{width:min(720px,100%);background:var(--card);border:1px solid var(--border);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden;}
    video{display:none;max-width:100%;border-top:1px solid var(--border);background:#000;}
    .preview{display:none;border-top:1px solid var(--border);background:#0c0f15;padding-bottom:10px;}
    .preview.active{display:block;}
    .preview-label{padding:10px 16px;font-weight:bold;}
    .preview img{display:block;width:100%;height:auto;object-fit:contain;background:#000;max-height:70dvh;}
    .second-preview{display:none;border-top:1px solid var(--border);padding:10px 16px;}
    .second-preview.active{display:block;}
    .second-preview img{width:100%;height:auto;}
    .settings{margin-top:10px;}
    .settings label{display:block;margin-top:8px;}
    .settings input[type=range]{width:60%;}
    .settings input[type=number]{width:80px;margin-left:10px;}
    .settings span{margin-left:10px;}
    .method-settings{margin-top:8px;padding:8px;background:rgba(255,255,255,0.05);border-radius:8px;border-left:3px solid var(--accent);}
    .palette {display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
    .color-item{box-sizing:border-box;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;margin:0;flex:0 0 calc((100% - 20px)/3);max-width:calc((100% - 20px)/3);}
    .color-circle{width:32px;height:32px;border-radius:50%;border:2px solid #fff;cursor:pointer;}
    .color-code{font-size:12px;margin-top:4px;width:72px;padding:2px 4px;}
    .color-controls{display:flex;align-items:center;gap:6px;margin-top:4px;}
    .pipette-btn{padding:4px 6px;line-height:1;border:1px solid var(--border);background:transparent;color:var(--text);border-radius:6px;cursor:pointer;}
    #colorMaps img{box-sizing:border-box;flex:0 0 calc((100% - 20px)/3);max-width:calc((100% - 20px)/3);border:2px solid var(--border);}
  </style>
</head>
<body>
<div class="app">
  <header class="app-header">
    <button id="uploadBtn" class="primary" type="button">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
    <button id="cameraBtn" type="button">–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
    <button id="resetBtn" type="button" style="display:none">–°–±—Ä–æ—Å</button>
  </header>
  <main>
    <section class="card">
      <video id="cameraStream" autoplay playsinline></video>
      <canvas id="snapshotCanvas" style="display:none"></canvas>

      <!-- 1) -->
      <div id="preview" class="preview">
        <div class="preview-label">1)</div>
        <img id="previewImg" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä"/>
      </div>

      <!-- 2) -->
      <div id="secondPreview" class="second-preview">
        <div class="preview-label">2)</div>
        <img id="secondImg" alt="–ò–∑–º–µ–Ω—ë–Ω–Ω–æ–µ"/>
        <div class="settings">
          <label>
            –®–∏—Ä–∏–Ω–∞ (px):
            <input type="range" id="resolutionRange" min="50" max="1000" step="1" value="200">
            <input type="number" id="resolutionInput" min="50" max="1000" step="1" value="200">
            <span id="percentDisplay">20%</span>
          </label>
          <label>
            –†–∞–∑–º—ã—Ç–∏–µ (px):
            <input type="range" id="blurRange" min="0" max="20" step="0.1" value="0">
            <input type="number" id="blurInput" min="0" max="20" step="0.1" value="0">
          </label>
        </div>
      </div>

      <!-- 3) -->
      <div id="paletteSection" class="second-preview">
        <div class="preview-label">3)</div>
        <div class="settings">
          <label>
            –ú–µ—Ç–æ–¥ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏:
            <select id="clusteringMethod">
              <option value="kmeans" selected>k-means</option>
              <option value="tones">–ü–æ —Ç–æ–Ω–∞–º</option>
            </select>
          </label>
          <label>
            –ö–æ–ª-–≤–æ —Ü–≤–µ—Ç–æ–≤:
            <select id="colorCount">
              <option value="3" selected>3</option>
              <option value="6">6</option>
              <option value="9">9</option>
              <option value="12">12</option>
              <option value="15">15</option>
            </select>
          </label>
          <div id="kmeansSettings" class="method-settings">
            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è k-means (–ø–æ–∫–∞ –ø—É—Å—Ç—ã–µ) -->
          </div>
          <div id="tonesSettings" class="method-settings" style="display:none;">
            <label>
              –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è ŒîE:
              <input type="number" id="minDeltaE" min="1" max="100" value="25">
            </label>
            <label>
              –¢—ë–º–Ω—ã–µ:
              <input type="number" id="darkCount" min="0" max="9" value="1" style="width:40px;">
            </label>
            <label>
              –°—Ä–µ–¥–Ω–∏–µ:
              <input type="number" id="midCount" min="0" max="9" value="1" style="width:40px;">
            </label>
            <label>
              –°–≤–µ—Ç–ª—ã–µ:
              <input type="number" id="lightCount" min="0" max="9" value="1" style="width:40px;">
            </label>
          </div>
          <label>
            –°–º—è–≥—á–µ–Ω–∏–µ –º–∞—Å–æ–∫:
            <input type="range" id="maskBlur" min="0" max="20" step="0.1" value="0" style="width:100px;">
            <input type="number" id="maskBlurInput" min="0" max="20" step="0.1" value="0" style="width:40px;">
          </label>
        </div>
        <div id="palette" class="palette"></div>
        <div id="pipetteOverlay" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.85);justify-content:center;align-items:center;">
          <img id="pipetteImg" style="max-width:90vw;max-height:90vh;box-shadow:0 0 0 4px #fff;cursor:crosshair;"/>
        </div>
        <div id="colorMaps" style="margin-top:10px;display:flex;flex-wrap:wrap;gap:10px;"></div>
      </div>
    </section>
  </main>
</div>

<script>
// =========================
// –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Ä–∞–±–æ—Ç—É –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è Telegram,
// –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ, –∏–∑–º–µ–Ω–∏—Ç—å –µ–≥–æ —Ä–∞–∑–º–µ—Ä –∏ —Ä–∞–∑–º—ã—Ç–æ—Å—Ç—å,
// –∞ —Ç–∞–∫–∂–µ –ø–æ–ª—É—á–∏—Ç—å –ø–∞–ª–∏—Ç—Ä—É –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ –∏ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —Ü–≤–µ—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã.
// =========================

// –°–æ–∑–¥–∞—ë–º —Å–∫—Ä—ã—Ç—ã–π input –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
const fileInput=document.createElement('input');
fileInput.type='file'; // –¢–∏–ø input ‚Äî —Ñ–∞–π–ª
fileInput.accept='image/*'; // –ü—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
fileInput.capture='environment'; // –û—Ç–∫—Ä—ã–≤–∞—Ç—å –∫–∞–º–µ—Ä—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
fileInput.style.display='none'; // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
// –î–æ–±–∞–≤–ª—è–µ–º input –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
document.body.appendChild(fileInput);

// –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤—Å–µ –Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–æ –∏—Ö id
const uploadBtn=document.getElementById('uploadBtn'); // –ö–Ω–æ–ø–∫–∞ "–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª"
const cameraBtn=document.getElementById('cameraBtn'); // –ö–Ω–æ–ø–∫–∞ "–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ"
const resetBtn=document.getElementById('resetBtn'); // –ö–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å"
const preview=document.getElementById('preview'); // –ë–ª–æ–∫ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
const previewImg=document.getElementById('previewImg'); // –ö–∞—Ä—Ç–∏–Ω–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
const cameraStream=document.getElementById('cameraStream'); // –í–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã
const snapshotCanvas=document.getElementById('snapshotCanvas'); // –ö–∞–Ω–≤–∞—Å –¥–ª—è —Å–Ω–∏–º–∫–∞
const resolutionRange=document.getElementById('resolutionRange'); // –°–ª–∞–π–¥–µ—Ä —à–∏—Ä–∏–Ω—ã
const resolutionInput=document.getElementById('resolutionInput'); // –ü–æ–ª–µ —à–∏—Ä–∏–Ω—ã
const percentDisplay=document.getElementById('percentDisplay'); // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞
const secondPreview=document.getElementById('secondPreview'); // –ë–ª–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
const secondImg=document.getElementById('secondImg'); // –ò–∑–º–µ–Ω—ë–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
const blurRange=document.getElementById('blurRange'); // –°–ª–∞–π–¥–µ—Ä —Ä–∞–∑–º—ã—Ç–∏—è
const blurInput=document.getElementById('blurInput'); // –ü–æ–ª–µ —Ä–∞–∑–º—ã—Ç–∏—è
const paletteSection=document.getElementById('paletteSection'); // –ë–ª–æ–∫ –ø–∞–ª–∏—Ç—Ä—ã
const clusteringMethod=document.getElementById('clusteringMethod'); // –ú–µ—Ç–æ–¥ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
const colorCount=document.getElementById('colorCount'); // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–≤–µ—Ç–æ–≤
const paletteDiv=document.getElementById('palette'); // –ü–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤
const colorMaps=document.getElementById('colorMaps'); // –ë–ª–æ–∫ –¥–ª—è —Ü–≤–µ—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
const kmeansSettings=document.getElementById('kmeansSettings');
const tonesSettings=document.getElementById('tonesSettings');
const minDeltaEInput=document.getElementById('minDeltaE');
const darkCount=document.getElementById('darkCount');
const midCount=document.getElementById('midCount');
const lightCount=document.getElementById('lightCount');

// –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
const maskBlur = document.getElementById('maskBlur');
const maskBlurInput = document.getElementById('maskBlurInput');
// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–ª–∞–π–¥–µ—Ä–∞ –∏ –ø–æ–ª—è
maskBlur.addEventListener('input',()=>{maskBlurInput.value=maskBlur.value;generateColorMaps();});
maskBlurInput.addEventListener('input',()=>{maskBlur.value=maskBlurInput.value;generateColorMaps();});

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ø–∞–ª–∏—Ç—Ä—ã
let originalImage=null,originalWidth=0,currentPalette=[];

// --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ---
function loadDefaultImage() {
  const defaultImgUrl = 'https://sun9-83.userapi.com/s/v1/ig1/XJRPO-T4RuE0KFMctnOM20rCs68dYcO4H5KnFW6s5E_x1BlQhkN2lojil1AW11LQ6xGG1uKa.jpg?quality=96&as=32x40,48x60,72x90,108x135,160x200,240x300,360x449,480x599,540x674,640x799,720x899,865x1080&from=bu&cs=865x0';
  const img = new Image();
  img.crossOrigin = 'Anonymous'; // –í–∞–∂–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å canvas!
  img.onload = () => {
    // –ö–æ–ø–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ canvas –∏ –ø–æ–ª—É—á–∞–µ–º dataURL
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = img.width;
    tempCanvas.height = img.height;
    const ctx = tempCanvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
    const dataURL = tempCanvas.toDataURL('image/png');
    previewImg.src = dataURL;
    preview.classList.add('active');
    originalImage = dataURL;
    originalWidth = img.width;
    uploadBtn.style.display = '';
    cameraBtn.style.display = '';
    resetBtn.style.display = '';
    resolutionRange.max = img.width;
    resolutionInput.max = img.width;
    resolutionRange.value = img.width * 0.2;
    resolutionInput.value = img.width * 0.2;
    percentDisplay.textContent = '20%';
    applyResolution();
  };
  img.src = defaultImgUrl;
}
// --- –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ---
window.addEventListener('DOMContentLoaded', () => {
  loadDefaultImage();
  updateMethodInterface(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª" ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
uploadBtn.addEventListener('click',()=>fileInput.click());
// –ö–æ–≥–¥–∞ –≤—ã–±—Ä–∞–Ω —Ñ–∞–π–ª, –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞
fileInput.addEventListener('change',()=>{const f=fileInput.files?.[0];if(f)handleFile(f);});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–±—Ä–æ—Å" ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
resetBtn.addEventListener('click',()=>{
  fileInput.value='';
  previewImg.removeAttribute('src');
  preview.classList.remove('active');
  secondImg.removeAttribute('src');
  secondPreview.classList.remove('active');
  paletteSection.classList.remove('active');
  colorMaps.innerHTML='';
  cameraStream.style.display='none';
  resetBtn.style.display='none';
  uploadBtn.style.display='';
  cameraBtn.style.display='';
  resolutionRange.value=200;resolutionInput.value=200;percentDisplay.textContent='20%';
  blurRange.value=0;blurInput.value=0;
  originalImage=null;originalWidth=0;
  // –ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  loadDefaultImage();
  updateMethodInterface(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ" ‚Äî –≤–∫–ª—é—á–∞–µ—Ç –∫–∞–º–µ—Ä—É –∏ –¥–µ–ª–∞–µ—Ç —Å–Ω–∏–º–æ–∫ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
cameraBtn.addEventListener('click',async()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:true}); // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
    cameraStream.srcObject=stream;cameraStream.style.display='block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ
    setTimeout(()=>takeSnapshot(stream),3000); // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –¥–µ–ª–∞–µ–º —Å–Ω–∏–º–æ–∫
  }catch(err){alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É:'+err);}
});

// –§—É–Ω–∫—Ü–∏—è –¥–µ–ª–∞–µ—Ç —Å–Ω–∏–º–æ–∫ —Å –∫–∞–º–µ—Ä—ã –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –µ–≥–æ
function takeSnapshot(stream){
  const ctx=snapshotCanvas.getContext('2d');
  snapshotCanvas.width=cameraStream.videoWidth;
  snapshotCanvas.height=cameraStream.videoHeight;
  ctx.drawImage(cameraStream,0,0); // –ö–æ–ø–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –≤–∏–¥–µ–æ –Ω–∞ –∫–∞–Ω–≤–∞—Å
  const dataURL=snapshotCanvas.toDataURL('image/png'); // –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏
  previewImg.src=dataURL;preview.classList.add('active'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
  originalImage=dataURL;originalWidth=cameraStream.videoWidth; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
  cameraStream.style.display='none';stream.getTracks().forEach(t=>t.stop()); // –û—Ç–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É
  uploadBtn.style.display='none';cameraBtn.style.display='none';resetBtn.style.display=''; // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫–∏
  resolutionRange.value=originalWidth*0.2;resolutionInput.value=originalWidth*0.2;percentDisplay.textContent='20%'; // –°—Ç–∞–≤–∏–º —à–∏—Ä–∏–Ω—É 20%
  applyResolution(); // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
}

// –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function handleFile(file){
  if(!file||!file.type.startsWith('image/')){
    // –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    return;
  }
  const r = new FileReader();
  r.onload = () => {
    const img = new Image();
    img.onload = () => {
      previewImg.src = r.result;
      preview.classList.add('active');
      originalImage = r.result;
      originalWidth = img.width;
      uploadBtn.style.display = 'none';
      cameraBtn.style.display = 'none';
      resetBtn.style.display = '';
      resolutionRange.max = img.width;
      resolutionInput.max = img.width;
      resolutionRange.value = img.width * 0.2;
      resolutionInput.value = img.width * 0.2;
      percentDisplay.textContent = '20%';
      applyResolution();
    };
    img.src = r.result;
  };
  r.readAsDataURL(file);
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —à–∏—Ä–∏–Ω—ã
function updatePercent(){
  percentDisplay.textContent=Math.round((resolutionInput.value/originalWidth)*100)+'%';
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã –∏ —Ä–∞–∑–º—ã—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
resolutionRange.addEventListener('input',()=>{resolutionInput.value=resolutionRange.value;updatePercent();applyResolution();});
resolutionInput.addEventListener('input',()=>{resolutionRange.value=resolutionInput.value;updatePercent();applyResolution();});
blurRange.addEventListener('input',()=>{blurInput.value=blurRange.value;applyResolution();});
blurInput.addEventListener('input',()=>{blurRange.value=blurInput.value;applyResolution();});

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é —à–∏—Ä–∏–Ω—É –∏ —Ä–∞–∑–º—ã—Ç–∏–µ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
function applyResolution(){
  if(!originalImage)return;
  const img=new Image();
  img.onload=()=>{
    const newWidth=parseInt(resolutionInput.value);const scale=newWidth/originalWidth;
    const ctx=snapshotCanvas.getContext('2d');
    snapshotCanvas.width=newWidth;snapshotCanvas.height=img.height*scale;
    ctx.filter=`blur(${blurInput.value}px)`;ctx.drawImage(img,0,0,snapshotCanvas.width,snapshotCanvas.height);
    ctx.filter='';
    secondImg.onload = () => {
      secondPreview.classList.add('active');
      paletteSection.classList.add('active');
      extractPalette(); // —Ç–µ–ø–µ—Ä—å –ø–∞–ª–∏—Ç—Ä–∞ —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ —Ä–µ–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
    };
    secondImg.src=snapshotCanvas.toDataURL('image/png');
    secondImg.style.width='100%';
  };
  img.src=originalImage;
}

// ======= –ü–∞–ª–∏—Ç—Ä–∞ —Å –≤—ã–±–æ—Ä–æ–º –º–µ—Ç–æ–¥–∞ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏ =======

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞
function updateMethodInterface() {
  const method = clusteringMethod.value;
  
  if (method === 'kmeans') {
    kmeansSettings.style.display = 'none';
    tonesSettings.style.display = 'none';
  } else if (method === 'tones') {
    kmeansSettings.style.display = 'none';
    tonesSettings.style.display = 'block';
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –º–µ—Ç–æ–¥ –ø–æ —Ç–æ–Ω–∞–º
    updateTonesProportions();
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ü–≤–µ—Ç–æ–≤ –≤ –º–µ—Ç–æ–¥–µ –ø–æ —Ç–æ–Ω–∞–º
function updateTonesColorCount() {
  const darkN = parseInt(darkCount.value) || 0;
  const midN = parseInt(midCount.value) || 0;
  const lightN = parseInt(lightCount.value) || 0;
  const total = darkN + midN + lightN;
  
  if (total > 0) {
    colorCount.value = total;
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ü–≤–µ—Ç–æ–≤
function updateTonesProportions() {
  const total = parseInt(colorCount.value) || 3;
  const perGroup = Math.floor(total / 3);
  const remainder = total % 3;
  
  // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä–æ–≤–Ω—É, –æ—Å—Ç–∞—Ç–æ–∫ –¥–æ–±–∞–≤–ª—è–µ–º –∫ —Å—Ä–µ–¥–Ω–∏–º —Ç–æ–Ω–∞–º
  darkCount.value = perGroup;
  midCount.value = perGroup + remainder;
  lightCount.value = perGroup;
}
// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Ü–≤–µ—Ç –∏–∑ RGB –≤ LAB (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ä–∞–∑–ª–∏—á–∏—è —Ü–≤–µ—Ç–æ–≤)
function rgbToLab(r,g,b){function pivot(n){return n>0.008856?Math.pow(n,1/3):(7.787*n)+(16/116);}
  r/=255;g/=255;b/=255;
  r=r>0.04045?Math.pow((r+0.055)/1.055,2.4):r/12.92;
  g=g>0.04045?Math.pow((g+0.055)/1.055,2.4):g/12.92;
  b=b>0.04045?Math.pow((b+0.055)/1.055,2.4):b/12.92;
  let x=(r*0.4124+g*0.3576+b*0.1805)/0.95047;
  let y=(r*0.2126+g*0.7152+b*0.0722)/1.000;
  let z=(r*0.0193+g*0.1192+b*0.9505)/1.08883;
  x=pivot(x);y=pivot(y);z=pivot(z);
  return[(116*y)-16,500*(x-y),200*(y-z)];
}

// –§—É–Ω–∫—Ü–∏—è —Å—á–∏—Ç–∞–µ—Ç "—Ä–∞–∑–ª–∏—á–∏–µ" –º–µ–∂–¥—É –¥–≤—É–º—è —Ü–≤–µ—Ç–∞–º–∏ –≤ LAB
function deltaE(a,b){return Math.sqrt((a[0]-b[0])**2+(a[1]-b[1])**2+(a[2]-b[2])**2);}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ü–µ–Ω—Ç—Ä–æ–∏–¥–æ–≤ k-means
function initializeCentroids(colors, k) {
  const centroids = [];
  // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∫–∞–∫ –Ω–∞—á–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—Ç—Ä–æ–∏–¥—ã
  for (let i = 0; i < k; i++) {
    const randomIndex = Math.floor(Math.random() * colors.length);
    centroids.push([...colors[randomIndex]]);
  }
  return centroids;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –±–ª–∏–∂–∞–π—à–µ–≥–æ —Ü–µ–Ω—Ç—Ä–æ–∏–¥–∞
function findNearestCentroid(color, centroids) {
  let minDistance = Infinity;
  let nearestIndex = 0;
  
  for (let i = 0; i < centroids.length; i++) {
    const distance = deltaE(rgbToLab(...color), rgbToLab(...centroids[i]));
    if (distance < minDistance) {
      minDistance = distance;
      nearestIndex = i;
    }
  }
  
  return nearestIndex;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ü–µ–Ω—Ç—Ä–æ–∏–¥–∞ (—Å—Ä–µ–¥–Ω–µ–≥–æ —Ü–≤–µ—Ç–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞)
function calculateNewCentroid(cluster) {
  if (cluster.length === 0) return [0, 0, 0];
  
  const sumR = cluster.reduce((sum, color) => sum + color[0], 0);
  const sumG = cluster.reduce((sum, color) => sum + color[1], 0);
  const sumB = cluster.reduce((sum, color) => sum + color[2], 0);
  
  return [
    Math.round(sumR / cluster.length),
    Math.round(sumG / cluster.length),
    Math.round(sumB / cluster.length)
  ];
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è k-means –∞–ª–≥–æ—Ä–∏—Ç–º–∞
function kMeansClustering(colors, k, maxIterations = 100) {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ü–µ–Ω—Ç—Ä–æ–∏–¥—ã
  let centroids = initializeCentroids(colors, k);
  let clusters = Array(k).fill().map(() => []);
  let iterations = 0;
  
  while (iterations < maxIterations) {
    // –û—á–∏—â–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã
    clusters = Array(k).fill().map(() => []);
    
    // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç–∞ –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º
    for (const color of colors) {
      const nearestIndex = findNearestCentroid(color, centroids);
      clusters[nearestIndex].push(color);
    }
    
    // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ —Ü–µ–Ω—Ç—Ä–æ–∏–¥—ã
    const newCentroids = clusters.map(cluster => calculateNewCentroid(cluster));
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ —Ü–µ–Ω—Ç—Ä–æ–∏–¥—ã
    let centroidsChanged = false;
    for (let i = 0; i < k; i++) {
      if (deltaE(rgbToLab(...centroids[i]), rgbToLab(...newCentroids[i])) > 1) {
        centroidsChanged = true;
        break;
      }
    }
    
    if (!centroidsChanged) break;
    
    centroids = newCentroids;
    iterations++;
  }
  
  return centroids;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ü–≤–µ—Ç–æ–≤ –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ä–∞–∑–Ω–∏—Ü–µ (ŒîE)
function filterColorsByDeltaE(colors, minDeltaE) {
  let res = [];
  colors.forEach(c => {
    let lab = rgbToLab(c[0], c[1], c[2]);
    if (!res.some(r => deltaE(lab, r.lab) < minDeltaE)) {
      res.push({rgb: c, lab});
    }
  });
  return res.map(r => r.rgb);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ —Ç–æ–Ω–∞–º (—Å—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥)
function clusterByTones(colors) {
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —è—Ä–∫–æ—Å—Ç–∏ (L –∏–∑ LAB)
  let colorsWithL = colors.map(rgb => {
    let lab = rgbToLab(rgb[0], rgb[1], rgb[2]);
    return {rgb, L: lab[0]};
  });
  colorsWithL.sort((a, b) => a.L - b.L);
  
  // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ 3 –≥—Ä—É–ø–ø—ã: —Ç—ë–º–Ω—ã–µ, —Å—Ä–µ–¥–Ω–∏–µ, —Å–≤–µ—Ç–ª—ã–µ
  let n = colorsWithL.length;
  let borders = [Math.floor(n/3), Math.floor(2*n/3)];
  let groups = [[], [], []];
  
  for (let i = 0; i < n; i++) {
    if (i < borders[0]) groups[0].push(colorsWithL[i].rgb);
    else if (i < borders[1]) groups[1].push(colorsWithL[i].rgb);
    else groups[2].push(colorsWithL[i].rgb);
  }
  
  // –ü–æ–ª—É—á–∞–µ–º –∂–µ–ª–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã
  let darkN = parseInt(darkCount.value) || 0;
  let midN = parseInt(midCount.value) || 0;
  let lightN = parseInt(lightCount.value) || 0;
  
  // –í –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ –≤—ã–±–∏—Ä–∞–µ–º –æ—Ç–ª–∏—á–∞—é—â–∏–µ—Å—è —Ü–≤–µ—Ç–∞
  let uniq = [];
  let filteredDark = filterColorsByDeltaE(groups[0], parseInt(minDeltaEInput.value));
  let filteredMid = filterColorsByDeltaE(groups[1], parseInt(minDeltaEInput.value));
  let filteredLight = filterColorsByDeltaE(groups[2], parseInt(minDeltaEInput.value));
  
  uniq = uniq.concat(filteredDark.slice(0, darkN));
  uniq = uniq.concat(filteredMid.slice(0, midN));
  uniq = uniq.concat(filteredLight.slice(0, lightN));
  
  return uniq;
}

// –ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–∞–ª–∏—Ç—Ä—É –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—è –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥
function extractPalette(){
 if(!secondImg.src)return;
 const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');
 canvas.width=secondImg.naturalWidth;canvas.height=secondImg.naturalHeight;
 ctx.drawImage(secondImg,0,0);
 const data=ctx.getImageData(0,0,canvas.width,canvas.height).data;
 
 // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ü–≤–µ—Ç–∞ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∫–∞–∂–¥—ã–π 4-–π –ø–∏–∫—Å–µ–ª—å –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
 let sampleColors=[];
 for(let i=0;i<data.length;i+=4*4){sampleColors.push([data[i],data[i+1],data[i+2]]);}
 
 const method = clusteringMethod.value;
 let resultColors = [];
 
 if (method === 'kmeans') {
   // –ü—Ä–∏–º–µ–Ω—è–µ–º k-means –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–∏–∫—Å–µ–ª–µ–π –ø–æ —Ü–≤–µ—Ç–∞–º
   let total = parseInt(colorCount.value) || 3;
   const centroids = kMeansClustering(sampleColors, total);
   resultColors = centroids;
 } else if (method === 'tones') {
   // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é –ø–æ —Ç–æ–Ω–∞–º
   resultColors = clusterByTones(sampleColors);
 }
 
 // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ü–≤–µ—Ç–∞ –≤ HEX —Ñ–æ—Ä–º–∞—Ç
 currentPalette = resultColors.map(c => '#' + ((1<<24)+(c[0]<<16)+(c[1]<<8)+c[2]).toString(16).slice(1));
 
 renderPalette();
 generateColorMaps();
}
// –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–∞–ª–∏—Ç—Ä—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–µ–Ω—è—Ç—å —Ü–≤–µ—Ç–∞ –≤—Ä—É—á–Ω—É—é
function renderPalette(){
  paletteDiv.innerHTML='';
  currentPalette.forEach((col,idx)=>{
    const item=document.createElement('div');item.className='color-item';
    const circle=document.createElement('input');circle.type='color';circle.value=col;circle.className='color-circle';
    const code=document.createElement('input');code.type='text';code.value=col;code.className='color-code';
    code.maxLength = 7;
    // –ö–Ω–æ–ø–∫–∞-–ø–∏–ø–µ—Ç–∫–∞
    const pipBtn=document.createElement('button');
    pipBtn.innerHTML='üñåÔ∏è';
    pipBtn.title='–í—ã–±—Ä–∞—Ç—å —Ü–≤–µ—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
    pipBtn.className='pipette-btn';
    pipBtn.addEventListener('click',function(e){
      e.stopPropagation();
      window.__activePipetteIndex = idx;
      pipetteImg.src = secondImg.src;
      pipetteOverlay.style.display = 'flex';
    });
    // –°–æ–±—ã—Ç–∏—è –¥–ª—è circle –∏ code
    circle.addEventListener('input',()=>{
      code.value=circle.value;
      currentPalette[idx]=circle.value;
      generateColorMaps();
    });
    code.addEventListener('input',()=>{
      circle.value=code.value;
      currentPalette[idx]=code.value;
      generateColorMaps();
    });
    // –°—Ç—Ä–æ–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–µ–º –∏ –ø–∏–ø–µ—Ç–∫–æ–π
    const controls=document.createElement('div');
    controls.className='color-controls';
    controls.appendChild(code);
    controls.appendChild(pipBtn);
    // –°–±–æ—Ä–∫–∞
    item.appendChild(circle);
    item.appendChild(controls);
    paletteDiv.appendChild(item);
  });
}
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ—Ç–æ–¥–æ–≤ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–ª–∏—Ç—Ä—ã
clusteringMethod.addEventListener('change', () => {
  updateMethodInterface();
  extractPalette();
});

// –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–ª–∏—Ç—Ä—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ü–≤–µ—Ç–æ–≤
colorCount.addEventListener('change', () => {
  // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –º–µ—Ç–æ–¥ –ø–æ —Ç–æ–Ω–∞–º, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
  if (clusteringMethod.value === 'tones') {
    updateTonesProportions();
  }
  extractPalette();
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–µ—Ç–æ–¥–∞ –ø–æ —Ç–æ–Ω–∞–º
minDeltaEInput.addEventListener('input', extractPalette);
darkCount.addEventListener('input', () => {
  // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—É–º–º–∞ –±–æ–ª—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
  const darkN = parseInt(darkCount.value) || 0;
  const midN = parseInt(midCount.value) || 0;
  const lightN = parseInt(lightCount.value) || 0;
  const total = darkN + midN + lightN;
  const currentTotal = parseInt(colorCount.value) || 0;
  
  if (total > currentTotal) {
    colorCount.value = total;
  }
  extractPalette();
});
midCount.addEventListener('input', () => {
  // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—É–º–º–∞ –±–æ–ª—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
  const darkN = parseInt(darkCount.value) || 0;
  const midN = parseInt(midCount.value) || 0;
  const lightN = parseInt(lightCount.value) || 0;
  const total = darkN + midN + lightN;
  const currentTotal = parseInt(colorCount.value) || 0;
  
  if (total > currentTotal) {
    colorCount.value = total;
  }
  extractPalette();
});
lightCount.addEventListener('input', () => {
  // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—É–º–º–∞ –±–æ–ª—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
  const darkN = parseInt(darkCount.value) || 0;
  const midN = parseInt(midCount.value) || 0;
  const lightN = parseInt(lightCount.value) || 0;
  const total = darkN + midN + lightN;
  const currentTotal = parseInt(colorCount.value) || 0;
  
  if (total > currentTotal) {
    colorCount.value = total;
  }
  extractPalette();
});

// ====== –ö–∞—Ä—Ç—ã ======
// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç (–≤—ã–Ω–µ—Å–µ–Ω–∞ –∏–∑ buildMapsBtn)
function generateColorMaps(){
  colorMaps.innerHTML='';
  if(!secondImg.src||currentPalette.length===0)return;
  const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');
  canvas.width=secondImg.naturalWidth;canvas.height=secondImg.naturalHeight;
  ctx.drawImage(secondImg,0,0);const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
  const data=imageData.data;
  // –ü–µ—Ä–µ–≤–æ–¥–∏–º —Ü–≤–µ—Ç–∞ –ø–∞–ª–∏—Ç—Ä—ã –∏–∑ HEX –≤ RGB
  const paletteRGB=currentPalette.map(hex=>{
    const bigint=parseInt(hex.slice(1),16);
    return[(bigint>>16)&255,(bigint>>8)&255,(bigint)&255];
  });
  // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ü–≤–µ—Ç–∞ —Å–æ–∑–¥–∞—ë–º –æ—Ç–¥–µ–ª—å–Ω—É—é –∫–∞—Ä—Ç—É
  paletteRGB.forEach((color,index)=>{
    const mapCanvas=document.createElement('canvas');const mapCtx=mapCanvas.getContext('2d');
    mapCanvas.width=canvas.width;mapCanvas.height=canvas.height;
    const mapImageData=mapCtx.createImageData(canvas.width,canvas.height);const mapData=mapImageData.data;
    for(let i=0;i<data.length;i+=4){
      const r=data[i],g=data[i+1],b=data[i+2];
      // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∏–∫—Å–µ–ª—è –∏—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π —Ü–≤–µ—Ç –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã
      const distances=paletteRGB.map(c=>Math.sqrt((r-c[0])**2+(g-c[1])**2+(b-c[2])**2));
      const minIndex=distances.indexOf(Math.min(...distances));
      // –ï—Å–ª–∏ —ç—Ç–æ—Ç —Ü–≤–µ—Ç ‚Äî —Ç–µ–∫—É—â–∏–π, –¥–µ–ª–∞–µ–º –ø–∏–∫—Å–µ–ª—å —á—ë—Ä–Ω—ã–º, –∏–Ω–∞—á–µ –±–µ–ª—ã–º
      if(minIndex===index){mapData[i]=0;mapData[i+1]=0;mapData[i+2]=0;mapData[i+3]=255;}
      else{mapData[i]=255;mapData[i+1]=255;mapData[i+2]=255;mapData[i+3]=255;}
    }
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–∞–∑–º—ã—Ç–∏–µ –∫ –º–∞—Å–∫–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    let blurValue = parseInt(maskBlur.value)||0;
    if(blurValue>0){
      mapCtx.putImageData(mapImageData,0,0);
      mapCtx.filter = `blur(${blurValue}px)`;
      mapCtx.drawImage(mapCanvas,0,0);
      mapCtx.filter = '';
      // –ü–æ—Å–ª–µ —Ä–∞–∑–º—ã—Ç–∏—è —Å–Ω–æ–≤–∞ –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      const blurred = mapCtx.getImageData(0,0,mapCanvas.width,mapCanvas.height);
      mapCtx.putImageData(blurred,0,0);
    } else {
      mapCtx.putImageData(mapImageData,0,0);
    }
    const img=document.createElement('img');img.src=mapCanvas.toDataURL();
    img.style.border = `4px solid ${currentPalette[index]}`;colorMaps.appendChild(img);
  });
}

// === –ü–∏–ø–µ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ===
// –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–≤–µ—Ä–ª–µ–π –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
const pipetteOverlay = document.getElementById('pipetteOverlay');
const pipetteImg = document.getElementById('pipetteImg');

// –û—Ç–∫—Ä—ã—Ç–∏–µ —Ä–µ–∂–∏–º–∞ –ø–∏–ø–µ—Ç–∫–∏
pipetteImg.addEventListener('click', function(e) {
  if (!secondImg.src) return;
  pipetteImg.src = secondImg.src;
  pipetteOverlay.style.display = 'flex';
});
// –ö–ª–∏–∫ –ø–æ –æ–≤–µ—Ä–ª–µ—é –≤–Ω–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ ‚Äî –∑–∞–∫—Ä—ã—Ç—å
pipetteOverlay.addEventListener('click', function(e) {
  if (e.target === pipetteOverlay) pipetteOverlay.style.display = 'none';
});
// –ö–ª–∏–∫ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –≤ –æ–≤–µ—Ä–ª–µ–µ ‚Äî –≤—ã–±–æ—Ä —Ü–≤–µ—Ç–∞
pipetteImg.addEventListener('click', function(e) {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º window.__activePipetteIndex
  const idx = window.__activePipetteIndex;
  if (typeof idx === 'undefined' || idx === null) return;
  const rect = pipetteImg.getBoundingClientRect();
  const x = Math.floor((e.clientX - rect.left) / rect.width * pipetteImg.naturalWidth);
  const y = Math.floor((e.clientY - rect.top) / rect.height * pipetteImg.naturalHeight);
  const canvas = document.createElement('canvas');
  canvas.width = pipetteImg.naturalWidth;
  canvas.height = pipetteImg.naturalHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(pipetteImg, 0, 0);
  const pixel = ctx.getImageData(x, y, 1, 1).data;
  const hex = '#' + [pixel[0], pixel[1], pixel[2]].map(v => v.toString(16).padStart(2, '0')).join('');
  currentPalette[idx] = hex;
  renderPalette();
  generateColorMaps();
  pipetteOverlay.style.display = 'none';
  window.__activePipetteIndex = null;
});
// –£–¥–∞–ª—è–µ–º –æ–±—ã—á–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ secondImg (–µ—Å–ª–∏ –±—ã–ª)
secondImg.onclick = null;
</script>
</body>
</html>
