<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1, minimum-scale=1" />
  <title>StringArt Generator — Telegram Mini App</title>
  
  <!-- Telegram Mini App Script -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Manifest for PWA support -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="assets/css/main.css?v=20250910i">
  <link rel="stylesheet" href="assets/css/components.css?v=20250910i">
  
  <!-- Meta tags for better SEO and sharing -->
  <meta name="description" content="Create StringArt templates from photos with advanced color analysis and k-means clustering">
  <meta name="keywords" content="stringart, telegram, miniapp, color analysis, image processing">
  <meta name="author" content="Tour_east">
  
  <!-- Open Graph meta tags -->
  <meta property="og:title" content="StringArt Generator">
  <meta property="og:description" content="Create StringArt templates from photos">
  <meta property="og:type" content="website">
  <meta property="og:image" content="i.webp">
  
  <!-- Telegram Mini App meta -->
  <meta name="telegram:card" content="app">
  <meta name="telegram:title" content="StringArt Generator">
  <meta name="telegram:description" content="Create StringArt templates from photos">
</head>
<body>
<div class="container" id="mainContainer">
<div class="app">
  <header class="app-header">
    <button id="addMediaBtn" class="primary" type="button">Добавить</button>
    <button id="testImageBtn" type="button">Тестовое изображение</button>
    <button id="resetBtn" type="button" style="display:none">Сброс</button>
  </header>
  
  <main>
    <section class="card">
      <!-- Camera Stream -->
      <video id="cameraStream" autoplay playsinline></video>
      <canvas id="snapshotCanvas" style="display:none"></canvas>

      <!-- Step 1: Image Preview -->
      <div id="preview" class="preview">
        <div class="preview-label">1) Исходное изображение</div>
        <img id="previewImg" alt="Предпросмотр"/>
      </div>

      <!-- Add Media Modal -->
      <div id="addMediaModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:1200;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg);border-radius:12px;padding:16px;max-width:320px;width:90%;">
          <div style="font-weight:bold;text-align:center;margin-bottom:12px;">Добавить изображение</div>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <button id="addMediaFromCamera" type="button" style="padding:10px 12px;background:var(--accent);border:none;border-radius:8px;color:#081018;cursor:pointer;">Сделать фото</button>
            <button id="addMediaFromFile" type="button" style="padding:10px 12px;background:var(--border);border:none;border-radius:8px;color:var(--text);cursor:pointer;">Выбрать из файла</button>
            <button id="addMediaCancel" type="button" style="padding:10px 12px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;">Отмена</button>
          </div>
        </div>
      </div>

      <!-- Step 2: Image Processing -->
      <div id="secondPreview" class="second-preview">
        <div class="preview-label">2) Обработка изображения</div>
        <img id="secondImg" alt="Обработанное изображение"/>
        <div class="settings">
          <label>
            Ширина (px):
            <input type="range" id="resolutionRange" min="50" max="1000" step="1" value="200">
            <input type="number" id="resolutionInput" min="50" max="1000" step="1" value="200">
            <span id="percentDisplay">20%</span>
          </label>
          <label>
            Размытие (px):
            <input type="range" id="blurRange" min="0" max="20" step="0.1" value="0">
            <input type="number" id="blurInput" min="0" max="20" step="0.1" value="0">
          </label>
        </div>
      </div>

      <!-- Step 3: Color Analysis -->
      <div id="paletteSection" class="second-preview">
        <div class="preview-label">3) Анализ цветов</div>
        
        <!-- Индикатор загрузки для анализа цветов -->
        <div id="paletteLoadingOverlay" class="loading-overlay">
          <div>
            <div class="loading-spinner"></div>
            <div class="loading-text">Анализ цветов...</div>
          </div>
        </div>
        
        <!-- Background Settings -->
        <div id="backgroundSettings" class="settings">
          <label style="font-weight:bold;">Цвет фона:</label>
          <div class="color-controls">
            <div class="bg-color-preset" style="width:24px;height:24px;border-radius:50%;background:#fff;border:2px solid #fff;cursor:pointer;display:inline-block;margin-right:8px;" data-bg="#ffffff" title="Белый"></div>
            <div class="bg-color-preset" style="width:24px;height:24px;border-radius:50%;background:#000;border:2px solid #fff;cursor:pointer;display:inline-block;margin-right:8px;" data-bg="#000000" title="Чёрный"></div>
            <div class="bg-color-preset" style="width:24px;height:24px;border-radius:50%;background:#888;border:2px solid #fff;cursor:pointer;display:inline-block;margin-right:8px;" data-bg="#888888" title="Серый"></div>
            <div id="bgColorDisplay" style="width:24px;height:24px;border-radius:50%;background:#ffffff;border:2px solid transparent;cursor:pointer;display:inline-block;position:relative;">
              <div style="position:absolute;inset:-3px;border-radius:50%;padding:2px;background:conic-gradient(red, yellow, lime, cyan, blue, magenta, red);
                          -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
                          -webkit-mask-composite: xor; mask-composite: exclude;"></div>
            </div>
            <input type="color" id="bgColorPicker" value="#ffffff" title="Выбрать цвет" style="display:none;">
            <button type="button" id="autoDetectBgBtn" class="pipette-btn" title="Автоматически определить цвет фона по краям изображения" style="margin-left:8px;">Авто</button>
            <span id="currentBgColor" style="margin-left:10px;user-select:text;">#ffffff</span>
          </div>
          <div style="margin-top:10px;">
            <label>Ширина полосы для автоопределения (%):
              <input type="number" id="bgEdgePercent" min="1" max="50" value="10" style="width:60px;">
            </label>
          </div>
        </div>
        
        <!-- Color Analysis Settings -->
        <div class="settings">
          <label>
            Метод кластеризации:
            <select id="clusteringMethod">
              <option value="kmeans" selected>k-means</option>
              <option value="tones">По тонам</option>
            </select>
          </label>
          <label>
            Кол-во цветов:
            <select id="colorCount">
              <option value="3" selected>3</option>
              <option value="6">6</option>
              <option value="9">9</option>
              <option value="12">12</option>
              <option value="15">15</option>
            </select>
          </label>
          
          <!-- k-means Settings -->
          <div id="kmeansSettings" class="method-settings" style="display:block;">
            <!-- Настройки для k-means -->
          </div>
          
          <!-- Tones Settings -->
          <div id="tonesSettings" class="method-settings" style="display:none;">
            <label>
              Минимальная ΔE:
              <input type="number" id="minDeltaE" min="1" max="100" value="25">
            </label>
            <label>
              Тёмные:
              <input type="number" id="darkCount" min="0" max="9" value="1" style="width:40px;">
            </label>
            <label>
              Средние:
              <input type="number" id="midCount" min="0" max="9" value="1" style="width:40px;">
            </label>
            <label>
              Светлые:
              <input type="number" id="lightCount" min="0" max="9" value="1" style="width:40px;">
            </label>
          </div>
        </div>
        
        <!-- Color Palette -->
        <div id="palette" class="palette"></div>
        
        <!-- Pipette Overlay -->
        <div id="pipetteOverlay">
          <img id="pipetteImg"/>
        </div>
        
        <!-- Color Palette Modal -->
        <div id="colorPaletteModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;">
          <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg);border-radius:12px;padding:20px;max-width:300px;width:90%;">
            <div style="text-align:center;margin-bottom:15px;font-weight:bold;">Выберите цвет</div>
            <div id="colorPaletteGrid" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:15px;"></div>
            <div style="text-align:center;">
              <button id="closePaletteModal" style="padding:8px 16px;background:var(--border);border:none;border-radius:6px;cursor:pointer;">Отмена</button>
            </div>
          </div>
        </div>

        <!-- Color Editor Modal (RGB + HEX + Pipette) -->
        <div id="colorEditorModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1001;">
          <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg);border-radius:12px;padding:16px;max-width:360px;width:92%;color:var(--text);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
              <div style="font-weight:bold;">Редактор цвета</div>
              <div id="colorEditorPreview" style="width:28px;height:28px;border-radius:6px;border:2px solid #fff;background:#ffffff;"></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
              <label style="display:flex;align-items:center;gap:8px;">HEX
                <input id="colorEditorHex" type="text" maxlength="7" placeholder="#ffffff" style="flex:1;padding:6px 8px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);">
              </label>
              <button id="colorEditorPipette" type="button" style="padding:8px 12px;background:var(--accent);border:none;border-radius:6px;color:#081018;cursor:pointer;">Пипетка</button>
            </div>
            <!-- HSV Canvas Picker -->
            <div style="display:flex;gap:10px;align-items:stretch;margin-bottom:12px;">
              <canvas id="colorEditorSV" width="240" height="160" style="border-radius:8px; overflow:hidden; touch-action:none; background:#fff; flex:1; max-width:100%;"></canvas>
              <canvas id="colorEditorHue" width="20" height="160" style="border-radius:8px; touch-action:none; background:#fff;"></canvas>
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;">
              <label style="display:flex;flex-direction:column;gap:6px;">R
                <input id="colorEditorR" type="number" min="0" max="255" value="255" style="padding:6px 8px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);">
              </label>
              <label style="display:flex;flex-direction:column;gap:6px;">G
                <input id="colorEditorG" type="number" min="0" max="255" value="255" style="padding:6px 8px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);">
              </label>
              <label style="display:flex;flex-direction:column;gap:6px;">B
                <input id="colorEditorB" type="number" min="0" max="255" value="255" style="padding:6px 8px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);">
              </label>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;">
              <button id="colorEditorCancel" type="button" style="padding:8px 12px;background:var(--border);border:none;border-radius:6px;color:var(--text);cursor:pointer;">Отмена</button>
              <button id="colorEditorOk" type="button" style="padding:8px 12px;background:var(--accent);border:none;border-radius:6px;color:#081018;cursor:pointer;">Готово</button>
            </div>
          </div>
        </div>
        
        <!-- Color Maps -->
        <div id="colorMaps" class="maps-container"></div>
      </div>

      <!-- Step 4: Actual Colors Mapping -->
      <div id="actualColorsSection" class="second-preview">
        <div class="preview-label">4) Сопоставление с фактическими цветами</div>
        
        <!-- Индикатор загрузки для масок -->
        <div id="masksLoadingOverlay" class="loading-overlay">
          <div>
            <div class="loading-spinner"></div>
            <div class="loading-text">Генерация масок...</div>
          </div>
        </div>
        <div class="settings">
          <label>
            Фактическая палитра (доступные цвета):
            <button id="addColorBtn" type="button" style="margin-left:10px;padding:4px 8px;background:var(--accent);border:none;border-radius:4px;color:#081018;cursor:pointer;">+ Добавить цвет</button>
          </label>
          <div id="actualPalette" class="palette" style="margin-top:10px;">
            <!-- Фактические цвета будут добавляться здесь -->
          </div>
          <div style="margin-top:15px;">
            <label>
              <input type="checkbox" id="syncWithCalculated" checked> Соответствие расчётной палитре
            </label>
            <label style="margin-left:15px;">
              <input type="checkbox" id="autoMatchColors" checked> Автоматическое сопоставление
            </label>
            <button id="syncPaletteBtn" type="button" style="margin-left:10px;padding:6px 12px;background:var(--accent);border:none;border-radius:6px;color:#081018;cursor:pointer;">Синхронизировать</button>
            <button id="matchColorsBtn" type="button" style="margin-left:10px;padding:6px 12px;background:var(--accent);border:none;border-radius:6px;color:#081018;cursor:pointer;">Сопоставить цвета</button>
          </div>
        </div>
        <div id="colorMapping" style="margin-top:15px;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;">
          <h4 style="margin:0 0 10px 0;">Сопоставление цветов:</h4>
          <div id="mappingList">
            <!-- Список сопоставлений будет здесь -->
          </div>
        </div>
        <div id="actualColorMaps" style="margin-top:15px;">
          <h4 style="margin:0 0 10px 0;">Маски с фактическими цветами: <span id="usedColorsInfo" style="font-size:12px;color:var(--muted);font-weight:normal;"></span></h4>
          <div id="actualMapsContainer" class="maps-container"></div>
        </div>
      </div>

      <!-- Step 5: StringArt Settings -->
      <div id="stringartSection" class="second-preview">
        <div class="preview-label">5) Настройки StringArt</div>
        
        <!-- Индикатор загрузки для StringArt -->
        <div id="stringartLoadingOverlay" class="loading-overlay">
          <div>
            <div class="loading-spinner"></div>
            <div class="loading-text">Генерация превью...</div>
          </div>
        </div>
        <div class="settings">
          <label>
            Форма полотна:
            <select id="canvasShape">
              <option value="circle" selected>Круглый</option>
              <option value="square">Квадратный</option>
            </select>
          </label>
          <label>
            Размер полотна:
            <select id="canvasSize">
              <option value="30" selected>30 см</option>
            </select>
          </label>
          <label>
            Количество гвоздей:
            <input type="number" id="nailCount" min="50" max="500" value="200" style="width:80px;">
          </label>
        </div>
        <div id="stringartPreview" style="margin-top:15px;text-align:center;">
          <h4 style="margin:0 0 10px 0;">Схема полотна:</h4>
          <canvas id="stringartCanvas" style="background:transparent;max-width:100%;height:auto;"></canvas>
          <div id="stringartInfo" style="margin-top:10px;font-size:12px;color:var(--muted);">
            Размер: 30 см | Гвоздей: 200 | Расстояние между гвоздями: ~0.47 см
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- JavaScript Modules -->
<script src="assets/js/utils.js?v=20250910"></script>
<script src="assets/js/telegramAPI.js?v=20250910"></script>
<script src="assets/js/imageProcessor.js?v=20250910"></script>
<script src="assets/js/colorAnalyzer.js?v=20250910b"></script>
<script src="assets/js/actualColors.js?v=20250910"></script>
<script src="assets/js/stringartGenerator.js?v=20250910"></script>
<script src="assets/js/app.js?v=20250910"></script>

<!-- Pipette functionality -->
<script>
// Обработчик пипетки (временно здесь, потом перенесем в отдельный модуль)
document.addEventListener('DOMContentLoaded', () => {
  const pipetteOverlay = document.getElementById('pipetteOverlay');
  const pipetteImg = document.getElementById('pipetteImg');
  
  // Клик по оверлею вне картинки — закрыть
  pipetteOverlay?.addEventListener('click', (e) => {
    if (e.target === pipetteOverlay) {
      pipetteOverlay.style.display = 'none';
    }
  });
  
  // Клик по изображению в оверлее — выбор цвета
  pipetteImg?.addEventListener('click', (e) => {
    const idx = window.__activePipetteIndex;
    const rect = pipetteImg.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / rect.width * pipetteImg.naturalWidth);
    const y = Math.floor((e.clientY - rect.top) / rect.height * pipetteImg.naturalHeight);
    
    const canvas = document.createElement('canvas');
    canvas.width = pipetteImg.naturalWidth;
    canvas.height = pipetteImg.naturalHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(pipetteImg, 0, 0);
    const pixel = ctx.getImageData(x, y, 1, 1).data;
    const hex = '#' + [pixel[0], pixel[1], pixel[2]].map(v => 
      v.toString(16).padStart(2, '0')
    ).join('');
    
    // Если задан глобальный колбэк редактора, вызываем его
    if (typeof window.__onPipettePick === 'function') {
      try { window.__onPipettePick(hex); } catch (_) {}
      window.__onPipettePick = null;
    } else if (window.stringArtApp && window.stringArtApp.colorAnalyzer && typeof idx === 'number') {
      // Fallback: обновляем расчётную палитру, если индекс задан
      window.stringArtApp.colorAnalyzer.updatePaletteColor(idx, hex);
      window.stringArtApp.colorAnalyzer.renderPalette();
      if (window.stringArtApp.actualColors && 
          document.getElementById('syncWithCalculated') && 
          document.getElementById('syncWithCalculated').checked) {
        window.stringArtApp.actualColors.syncActualWithCalculated();
      }
    }
    
    pipetteOverlay.style.display = 'none';
    window.__activePipetteIndex = null;
  });
});
</script>
</div>
</body>
</html>
